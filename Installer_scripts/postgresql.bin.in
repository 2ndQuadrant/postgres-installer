#!/bin/bash

PLPackage=_PLPACKAGE_
PGHome=_PGHOME_
PGPort=_PGPORT_

PGServerController() {


        if [[ "$1" == "start" ]]
        then

                if [[ -d $PLPackage ]]
                then

                        serverStatus=`sudo su postgres -c 'export PATH='"$PLPackage"'/Perl-5.26/bin:$PATH; export LD_LIBRARY_PATH='"$PLPackage"'/Perl-5.26/lib/CORE:$LD_LIBRARY_PATH; export PERL5LIB=/'"$PLPackage"'/Perl-5.26/lib; export PATH='"$PLPackage"'/Tcl-8.6/bin:$PATH;export LD_LIBRARY_PATH='"$PLPackage"'/Tcl-8.6/lib:$LD_LIBRARY_PATH; '"$PGHome"'/bin/pg_ctl -D '"$PGHome"'/data -o " -p '"$PGPort"'" -l /tmp/logfile '"$1"''`

                        return
                else
                        echo "Warning: Starting server without PL Languages support ..." >> servicelog.log 2>&1
                fi
        fi

        serverStatus=`sudo su postgres -c ''"$PGHome"'/bin/pg_ctl -D '"$PGHome"'/data -o " -p '"$PGPort"'" -l /tmp/logfile '"$1"''`


}



case "$1" in
start)

        PGServerController status

        if [[ $serverStatus == *"server is running"* ]]
        then
                echo "Server is already running ..."
        else
                rm -f /tmp/.s.PGSQL.* > /dev/null

                echo  "Starting PostgreSQL server ..."

                PGServerController start

                echo "Checking if server is properly started ..."

                PGServerController status

                if [[ $serverStatus == *"server is running"* ]]
                then
                        echo "Started successfully ..."
                else
                        echo "Unable to start the server"
                fi
        fi


;;


stop)

        echo "Stopping PostgreSQL server ..."

        PGServerController stop

        if [[ $serverStatus == *"stopped"* ]]
        then
                echo "Successfully stopped ..."
        else
                echo "Unable to stop the server ..."
        fi


;;


status)

        PGServerController status

        echo $serverStatus


;;


restart)
    $0 stop
    $0 start
;;


*)
    echo "Usage: postgresql {start|stop|status|restart}"
    exit 1
esac

exit 0
